CREATE DATABASE db_empl;

USE db_empl;

CREATE TABLE T_OFFICES(
	OFFC_ID int NOT NULL,
    OFFC_COUNTRY varchar(30) NOT NULL,
    OFFC_DESCRIPTION varchar(90) NOT NULL,
    OFFC_NAME varchar(30)
);

ALTER TABLE T_OFFICES
	DROP COLUMN OFFC_NAME;

ALTER TABLE T_OFFICES
	ADD COLUMN 
    OFFC_CITY varchar(50) NOT NULL;
    
ALTER TABLE T_OFFICES
	CHANGE COLUMN OFFC_DESCRIPTION 
    OFFC_DESCRIPTION varchar(100);
    
INSERT INTO T_OFFICES
		VALUES (10,'España','Oficina central','Madrid');
    
INSERT INTO T_OFFICES
		VALUES (11,'España',null,'Barcelona');
        
INSERT INTO T_OFFICES
		(OFFC_ID, OFFC_COUNTRY, OFFC_DESCRIPTION, OFFC_CITY)
		VALUES 
        (20,'Chile','Oficina principal de Chile','Santiago'),
        (30,'Argentina',null,'Buenos aires');    
    
SELECT 
	OFFC_ID, OFFC_COUNTRY 
    FROM T_OFFICES 
    WHERE OFFC_DESCRIPTION LIKE 'Oficina%';  
    
UPDATE T_OFFICES
	SET 
		OFFC_CITY = 'Buenos Aires'
	WHERE
		OFFC_CITY = 'Buenos aires';

CREATE TABLE T_KNOWLEDGE_LINES (
  KNLN_ID INT(11) NOT NULL,
  KNLN_NAME VARCHAR(45) NOT NULL,
  PRIMARY KEY (KNLN_ID)
);

INSERT INTO T_KNOWLEDGE_LINES (KNLN_ID, KNLN_NAME)
VALUES (10, 'Java');

INSERT INTO T_KNOWLEDGE_LINES (KNLN_ID, KNLN_NAME)
VALUES (20, '.NET');

INSERT INTO T_KNOWLEDGE_LINES (KNLN_ID, KNLN_NAME)
VALUES (30, 'Mainframe');

ALTER TABLE T_OFFICES
   ADD PRIMARY KEY (OFFC_ID);

CREATE TABLE T_EMPLOYEES(
	EMPL_ID INT NOT NULL AUTO_INCREMENT,
    OFFC_ID INT NOT NULL,
    KNLN_ID INT,
    EMPL_FORNAME VARCHAR(50) NOT NULL,
    EMPL_MIDDLE_NAME VARCHAR(50),
    EMPL_SURNAME VARCHAR(50) NOT NULL,
    EMPL_NUMBER INT NOT NULL,
    EMPL_HIRE_DATE DATETIME NOT NULL,
    EMPL_MENTOR_ID INT,
    PRIMARY KEY (EMPL_ID)
);

INSERT INTO T_EMPLOYEES 
	(OFFC_ID, KNLN_ID, EMPL_FORNAME, EMPL_SURNAME, EMPL_NUMBER, EMPL_HIRE_DATE)
    VALUES
    (10,10,'Juan','Perez',150,'2005-04-15');
    
    
INSERT INTO T_EMPLOYEES 
	(OFFC_ID, KNLN_ID, EMPL_FORNAME, EMPL_SURNAME, EMPL_NUMBER, EMPL_HIRE_DATE, EMPL_MENTOR_ID)
    VALUES
    (11,20,'Luis','Gonzalez',160,'2006-05-18',1);
    
INSERT INTO T_EMPLOYEES 
	(OFFC_ID, EMPL_FORNAME, EMPL_SURNAME, EMPL_NUMBER, EMPL_HIRE_DATE)
    VALUES
    (20,'Pedro','Garcia',180,'2006-05-18');
        
CREATE TABLE T_PROJECTS (
	PRJT_ID INT NOT NULL AUTO_INCREMENT,
    PRJT_CODE VARCHAR(16) NOT NULL,
    PRJT_NAME VARCHAR(50) NOT NULL,
    PRIMARY KEY (PRJT_ID)
);
    
CREATE TABLE T_PROJECTS_EMPLOYEES (
	PRJT_ID INT NOT NULL,
    EMPL_ID INT NOT NULL,
    PRIMARY KEY (PRJT_ID,EMPL_ID)
);
   
INSERT INTO T_PROJECTS
	(PRJT_CODE, PRJT_NAME)
    VALUES
    ('EXT-001000-01234','Gestion de usuarios'),
	('INT-001000-03200','Cursos de formacion');	
    
INSERT INTO T_PROJECTS_EMPLOYEES
	VALUES
		(1,1),
        (1,2),
        (2,1);

ALTER TABLE T_EMPLOYEES 
    ADD INDEX FK_EMPL_OFFC (OFFC_ID), 
    ADD CONSTRAINT FK_EMPL_OFFC 
        FOREIGN KEY (OFFC_ID) 
        REFERENCES T_OFFICES (OFFC_ID);

ALTER TABLE T_EMPLOYEES 
    ADD INDEX FK_EMPL_KNLN (KNLN_ID), 
    ADD CONSTRAINT FK_EMPL_KNLN 
        FOREIGN KEY (KNLN_ID) 
        REFERENCES T_KNOWLEDGE_LINES (KNLN_ID);

ALTER TABLE T_PROJECTS_EMPLOYEES
	ADD INDEX FK_PREM_PRJT (PRJT_ID),
    ADD CONSTRAINT FK_PREM_PRJT
		FOREIGN KEY (PRJT_ID)
        REFERENCES T_PROJECTS (PRJT_ID);

ALTER TABLE T_PROJECTS_EMPLOYEES
	ADD INDEX FK_PREM_EMPL (EMPL_ID),
    ADD CONSTRAINT FK_PREM_EMPL
		FOREIGN KEY (EMPL_ID)
        REFERENCES T_EMPLOYEES (EMPL_ID);

SELECT e.EMPL_FORNAME,e.EMPL_SURNAME, o.OFFC_CITY, k.KNLN_NAME
	FROM T_EMPLOYEES e
    INNER JOIN T_OFFICES o
		ON e.OFFC_ID = o.OFFC_ID
    LEFT JOIN T_KNOWLEDGE_LINES k
		ON e.KNLN_ID = k.KNLN_ID
    
	WHERE o.OFFC_COUNTRY IN ('España','Chile')
    AND e.EMPL_MENTOR_ID IS NULL;
    
SELECT p.PRJT_ID, p.PRJT_NAME, e.EMPL_FORNAME,e.EMPL_SURNAME
	FROM T_PROJECTS p
    inner JOIN T_PROJECTS_EMPLOYEES pe
		ON p.PRJT_ID = pe.PRJT_ID
    inner JOIN T_EMPLOYEES e 
		ON pe.EMPL_ID = e.EMPL_ID
    WHERE e.EMPL_FORNAME = 'Juan';    
 
# Solo los empleados que tienen asignada una linea de conocimiento 
SELECT e.EMPL_FORNAME, k.KNLN_NAME
	FROM T_EMPLOYEES e 
    join T_KNOWLEDGE_LINES k
		ON e.KNLN_ID = k.KNLN_ID;
        
# Muestra todas las lineas de conocimiento aunque no esten asignadas a 
# los empleados        
SELECT e.EMPL_FORNAME, k.KNLN_NAME
	FROM T_EMPLOYEES e 
    right outer join T_KNOWLEDGE_LINES k
		ON e.KNLN_ID = k.KNLN_ID;        

# Muestra todos los empleados con sus lineas de conocimiento,
# aunque sea null        
SELECT e.EMPL_FORNAME, k.KNLN_NAME
	FROM T_EMPLOYEES e 
    left outer join T_KNOWLEDGE_LINES k
		ON e.KNLN_ID = k.KNLN_ID;  
        
CREATE view V_PROJECTS_EMPLOYEES
	(PRJT_CODE, PRJT_NAME, EMPL_NUMBER, EMPL_FORNAME,EMPL_SURNAME)
	AS
    SELECT p.PRJT_CODE, p.PRJT_NAME, e.EMPL_NUMBER, e.EMPL_FORNAME,e.EMPL_SURNAME
	FROM T_PROJECTS p
    inner JOIN T_PROJECTS_EMPLOYEES pe
		ON p.PRJT_ID = pe.PRJT_ID
    inner JOIN T_EMPLOYEES e 
		ON pe.EMPL_ID = e.EMPL_ID;    
     

SELECT * 
	FROM v_projects_employees
    WHERE PRJT_CODE LIKE 'EXT%';
    
SELECT MAX(EMPL_FORNAME)
	FROM T_EMPLOYEES;
    
CREATE TABLE T_DOCUMENTS (
  DOCS_ID INT NOT NULL AUTO_INCREMENT,
  EMPL_ID INT NOT NULL,
  DOCS_NAME VARCHAR(100) NOT NULL,
  DOCS_TYPE VARCHAR(50) NOT NULL,
  PRIMARY KEY (DOCS_ID));
    
ALTER TABLE T_DOCUMENTS 
	ADD INDEX FK_DOCS_EMPL (EMPL_ID), 
    ADD CONSTRAINT FK_DOCS_EMPL 
        FOREIGN KEY (EMPL_ID) REFERENCES T_EMPLOYEES (EMPL_ID);

ALTER TABLE T_DOCUMENTS 
  ADD CONSTRAINT CT_CK_DOCS_TYPE
  CHECK('DOCS_TYPE' IN ('PDF','DOC','XLS'));

INSERT INTO `T_DOCUMENTS`
(`EMPL_ID`, `DOCS_NAME`, `DOCS_TYPE`)
VALUES
(1, 'Titulo', 'PDF'),
(1, 'Curriculum', 'DOC'),
(1, 'Certificado OCP', 'PDF'),
(1, 'Matriz conocimientos', 'XLS'),
(2, 'Grado', 'PDF'),
(2, 'Curriculum', 'DOC'),
(2, 'Certificado MS', 'PDF'),
(3, 'Titulo', 'PDF');

SELECT CONCAT(e.EMPL_FORNAME, ' ', e.EMPL_SURNAME) FULL_NAME, 
	COUNT(d.DOCS_ID) NUM_DOCS
	FROM T_EMPLOYEES e
    inner join T_DOCUMENTS d
    ON e.EMPL_ID=d.EMPL_ID
    GROUP BY FULL_NAME;
    
SELECT CONCAT(e.EMPL_FORNAME, ' ', e.EMPL_SURNAME) FULL_NAME, 
	COUNT(d.DOCS_ID) NUM_DOCS 
	FROM T_EMPLOYEES e
    inner join T_DOCUMENTS d
    ON e.EMPL_ID=d.EMPL_ID
    GROUP BY FULL_NAME
    ORDER BY NUM_DOCS ASC;
	
SELECT CONCAT(e.EMPL_FORNAME, ' ', e.EMPL_SURNAME) FULL_NAME, 
	COUNT(d.DOCS_ID) NUM_DOCS 
	FROM T_EMPLOYEES e
    inner join T_DOCUMENTS d
    ON e.EMPL_ID=d.EMPL_ID
    GROUP BY FULL_NAME
    ORDER BY NUM_DOCS ASC LIMIT 1,2;    


